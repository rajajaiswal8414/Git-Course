import { Component, OnInit } from '@angular/core';
import { HttpClientModule } from '@angular/common/http';
import { FormsModule } from '@angular/forms';
import { CommonModule } from '@angular/common';
import { RouterLink } from '@angular/router';
import { AppointmentResponseDTO } from '../../../models/appointment-interface';
import { AppointmentService } from '../../../core/services/patient-appointment.service';

@Component({
  selector: 'app-doctor-appointments',
  templateUrl: './doctor-appointments.html',
  imports: [FormsModule, CommonModule, HttpClientModule, RouterLink],
})
export class DoctorAppointments implements OnInit {
  appointments: AppointmentResponseDTO[] = [];
  filteredAppointments: AppointmentResponseDTO[] = [];
  currentAppointmentId: number | null = null;

  // Filters
  searchTerm = '';
  dateFilter = 'all';
  statusFilter = 'all';

  // Stats
  todayCount = 0;
  pendingCount = 0;
  confirmedCount = 0;
  completedCount = 0;

  constructor(private appointmentService: AppointmentService) {}

  ngOnInit(): void {
    this.loadAppointments();
  }

  loadAppointments(): void {
    this.appointmentService.getAppointmentsForDoctor().subscribe({
      next: (appointments) => {
        this.appointments = appointments || [];
        this.filteredAppointments = [...this.appointments];
        this.updateStats();
      },
      error: () => {
        this.appointments = [];
        this.filteredAppointments = [];
        this.updateStats();
      }
    });
  }

  updateStats(): void {
    const today = new Date().toISOString().split('T')[0];
    this.todayCount = this.appointments.filter((a) => a.appointmentDate === today).length;
    this.pendingCount = this.appointments.filter((a) => a.status === 'PENDING').length;
    this.confirmedCount = this.appointments.filter((a) => a.status === 'CONFIRMED').length;
    this.completedCount = this.appointments.filter((a) => a.status === 'COMPLETED').length;
  }

  formatTime(time: string): string {
    const [hours, minutes] = time.split(':');
    const hour = parseInt(hours, 10);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
  }

  filterAppointments(): void {
    const search = this.searchTerm.toLowerCase();
    const today = new Date();

    this.filteredAppointments = this.appointments.filter((a) => {
      const matchesSearch = a.patient.name.toLowerCase().includes(search);
      const matchesStatus = this.statusFilter === 'all' || a.status === this.statusFilter;
      const appointmentDate = new Date(a.appointmentDate);
      let matchesDate = true;

      if (this.dateFilter === 'today') {
        matchesDate = appointmentDate.toDateString() === today.toDateString();
      } else if (this.dateFilter === 'tomorrow') {
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        matchesDate = appointmentDate.toDateString() === tomorrow.toDateString();
      } else if (this.dateFilter === 'week') {
        const weekFromNow = new Date(today);
        weekFromNow.setDate(today.getDate() + 7);
        matchesDate = appointmentDate >= today && appointmentDate <= weekFromNow;
      }

      return matchesSearch && matchesStatus && matchesDate;
    });
  }

  confirmAppointment(id: number): void {
    const appointment = this.appointments.find((a) => a.appointmentId === id);
    if (!appointment) return;

    if (confirm(`Confirm appointment with ${appointment.patient.name}?`)) {
      appointment.status = 'CONFIRMED';
      this.updateStats();
      this.filterAppointments();
      alert(`âœ… Appointment confirmed for ${appointment.patient.name}`);
    }
  }

  cancelAppointment(id: number): void {
    const appointment = this.appointments.find((a) => a.appointmentId === id);
    if (!appointment) return;

    const reason = prompt('Please provide a reason for cancellation:');
    if (reason) {
      appointment.status = 'CANCELED';
      this.updateStats();
      this.filterAppointments();
      alert(`âŒ Appointment cancelled for ${appointment.patient.name}`);
    }
  }

  startConsultation(id: number): void {
    alert(`ðŸ©º Starting consultation for appointment ID: ${id}`);
  }

  viewNotes(notes: string): void {
    alert(`ðŸ“ Consultation Notes:\n\n${notes}`);
  }

  getInitials(name: string): string {
    if (!name) return '';
    return name
      .split(' ')
      .map((n) => n[0])
      .join('')
      .toUpperCase();
  }
}
